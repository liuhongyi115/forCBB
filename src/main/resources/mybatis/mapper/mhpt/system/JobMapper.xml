<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.taiji.cloudmp.mhpt.modules.system.repository.JobRepository" >
    <resultMap id="Job" type="com.taiji.cloudmp.mhpt.modules.system.domain.Job" >
        <id column="id" property="id" jdbcType="BIGINT" />
        <result column="name" property="name" jdbcType="VARCHAR" />
        <result column="sort" property="sort" jdbcType="BIGINT"/>
        <result column="enabled" property="enabled" jdbcType="BIT" />
        <result column="dept_id" property="deptId" jdbcType="BIGINT" />
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    </resultMap>

    <sql id="columns" >
        id, name, sort, enabled, dept_id, create_time
    </sql>
	
	<sql id="dynamicWhere">
		<where>
        	<if test="name != null">
        		name like concat(concat('%', #{name}),'%')
        	</if>
        	<if test="enabled != null and enabled == true ">
        		and enabled =1
        	</if>
        	<if test="enabled != null and enabled == false ">
        		and enabled =0
        	</if>
        	<if test="deptId != null">
        		and dept_id = #{deptId}
        	</if>
        	<if test="deptIds != null and deptIds.size > 0">
        		and dept_id in 
        			<foreach collection="deptIds" open="(" separator="," close=")" item="val">
    					${val}
					</foreach>
        	</if>
        </where>
	</sql>
	
	<insert id="add" parameterType="com.taiji.cloudmp.mhpt.modules.system.domain.Job" >
		<selectKey resultType="java.lang.Long" order="AFTER" keyProperty="id">
 			SELECT LAST_INSERT_ID()
  		</selectKey>
    	INSERT INTO t_cloudmp_job ( name, sort, enabled, dept_id, create_time) 
        VALUES (#{name}, #{sort}, #{enabled}, #{deptId}, #{createTime})
    </insert>
	
	<update id="update" parameterType="com.taiji.cloudmp.mhpt.modules.system.domain.Job">
		update t_cloudmp_job set
		<if test="name != null"> name = #{name},</if>
		<if test="sort != null"> sort = #{sort},</if>
		<if test="enabled != null and enabled == true">  enabled = 1,</if>
		<if test="enabled != null and enabled == false"> enabled = 0,</if>
		<if test="deptId != null"> dept_id = #{deptId},</if>
		<if test="createTime != null"> create_time = #{createTime},</if>
		id = #{id}
		where id = #{id}
	</update>
	
	<delete id="deleteById" parameterType="java.lang.Long" >
    	delete from t_cloudmp_job
    	where id =#{id}
    </delete>
    
    <select id="findAll" parameterType="com.taiji.cloudmp.mhpt.modules.system.service.dto.JobQueryCriteria" resultMap="Job"  >
    	SELECT <include refid="columns" />
        FROM t_cloudmp_job
       	<include refid="dynamicWhere" />
       	<if test="pager.orderCondition != null and pager.orderCondition != ''">
			${pager.orderCondition}
		</if>
		<if test="pager.DBPageCondition != null and pager.DBPageCondition != ''">
			${pager.DBPageCondition}
		</if>
    </select>
	
	<select id="findById" parameterType="java.lang.Long" resultMap="Job">
		select <include refid="columns" />
		from t_cloudmp_job
		where id =#{id}
	</select>
	
    <select id="findTotalCount" resultType="java.lang.Long" >
		select count(1)
		FROM t_cloudmp_job 
		<include refid="dynamicWhere" />
	</select>
	
	<select id="findDeptCountInJob" parameterType="java.lang.Object" resultType="java.lang.Long" >
   		SELECT COUNT(1) FROM t_cloudmp_job j WHERE dept_id = #{deptId};
	</select>
</mapper>